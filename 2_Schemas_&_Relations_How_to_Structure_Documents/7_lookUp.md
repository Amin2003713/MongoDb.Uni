
---

مرحله لولوکاپ (Lookup) aggregation pipeline stage in MongoDB اصولاً برای ادغام داده‌ها از مجموعه‌های مختلف بر اساس روابط
مشخص
استفاده می‌شود، نه برای ادغام روابط مرجع خود. با این حال، این مرحله می‌تواند گامی حیاتی در فرایند بازیابی و پتانسیلی در
دخیل ساختن داده‌ها در عملیات ادغام باشد.

اینجا چگونگی استفاده از لولوکاپ در زمینه ادغام روابط مرجع آورده شده است:

**سناریو:**

تصور کنید دو پایگاه داده (یا مجموعه‌ها) وجود دارد که نیاز به ادغام دارند. هر دو پایگاه داده حاوی اطلاعات کاربر و
احتمالاً اسناد مرجع از مجموعه‌های دیگر مانند آدرس‌ها یا سفارش‌ها هستند.

**مراحل استفاده از لولوکاپ:**

1. **بازیابی داده با استفاده از لولوکاپ:**

- از مرحله لولوکاپ در لوله‌کشی‌های تجمعی برای بازیابی داده‌های مرتبط از هر دو پایگاه داده استفاده کنید.
- سند‌های کاربر را با اسناد مرجع متناظرشان (مانند آدرس‌ها، سفارشات) بر اساس روابط کلید خارجی ادغام کنید.

2. **تبدیل داده‌ها (اختیاری):**

- پس از بازیابی داده‌ها با استفاده از لولوکاپ، ممکن است نیاز به انجام تبدیل‌های اضافی برای یکپارچه‌سازی ساختار یا محتوای
  اسناد قبل از ادغام آنها داشته باشید. این ممکن است شامل موارد زیر باشد:
    - تغییر نام فیلدها با نام‌های مختلف در پایگاه‌های داده.
    - استانداردسازی فرمت داده‌ها (مانند فرمت تاریخ).
    - انتخاب زیرمجموعه‌های خاصی از داده برای سند ادغام شده.

3. **ادغام اسناد (فرآیند خارجی):**

- واقعیت ادغام اسناد معمولاً خارج از لوله‌کشی تجمعی اتفاق می‌افتد، احتمالاً در منطق برنامه‌ی شما.
- می‌توانید از داده‌های بازیابی شده و ممکن است تغییر یافته از مراحل لولوکاپ برای ایجاد اسناد ادغام شده با ساختار مورد
  نظر استفاده کنید.

اینجا چند دستور پوسته MongoDB را نشان می‌دهد که استفاده از `$lookup` برای بازیابی داده‌ها با روابط مرجع را نشان می‌دهد:

**۱. رابطه یک به یک (مجموعه‌های مرجع):**

```javascript
// فرض کنید مجموعه‌های: users، addresses و user_addresses (مجموعه مرجع) وجود دارد

// جستجوی اسناد کاربر و پر کردن فیلد "آدرس" با داده‌های مرتبط آدرس
db.users.aggregate([
  {
    $lookup: {
      from: "addresses",
      localField: "_id",  // شناسه کاربر به عنوان مرجع آدرس
      foreignField: "userId",  // سند آدرس به عنوان مرجع کاربر
      as: "address"
    }
  }
])
```

این پرس و جو اسناد کاربر را بازیابی کرده و فیلد `address` را داخل هر سند کاربر با داده‌های سند مرتبط آدرس در
مجموعه `addresses` پر می‌کند، بر اساس ارتباط برقرار شده در مجموعه `user_addresses`.

**۲. رابطه چند به چند (مجموعه‌های مرجع):**

```javascript
// فرض کنید مجموعه‌های: courses، students و course_enrollments (مجموعه مرجع) وجود دارد

// جستجوی اسناد دانشجو و پر کردن فیلد "دوره‌های ثبت‌نام‌شده" با جزئیات دوره‌های ثبت‌نام شده
db.students.aggregate([
  {
    $lookup: {
      from: "courses",
      localField: "_id",  // شناسه دانشجو به عنوان مرجع دوره‌ها
      foreignField: "enrolledStudents",  // دوره به عنوان مرجع دانشجوهای ثبت‌نام‌شده (آرایه)
      as: "enrolledCourses"
    }
  }
])
```

این پرس و جو اسناد دانشجو را بازیابی کرده و فیلد `enrolledCourses` را با آرایه‌ای از اسناد دوره برای هر دانشجو پر
می‌کند. اتصال بین دانشجوها و دوره‌ها از طریق مجموعه `course_enrollments` برقرار می‌شود، جایی که شناسه یک دانشجو به
دوره‌هایی که در آن‌ها ثبت‌نام شده‌اند ارجاع شده است (به عنوان یک آرایه داخل سند دوره).

**۳. استفاده از متغیرها:**

```javascript
// تعریف یک متغیر برای شناسه کاربر
var userId = ObjectId("63cab8c7e4b021d2a7f78b12");

// جستجوی کاربر با شناسه خاص و پر کردن آدرس
db.users.aggregate([
  {
    $lookup: {
      from: "addresses",
      localField: "_id",
      foreignField: "userId",
      as: "address"
    }
  },
  { $match: { "_id": userId } }  // فیلتر کردن بر اساس شناسه کاربر
])
```

این مثال یک متغیر `userId` را برای نمایش یک کاربر خاص معرفی می‌کند. پرس‌وجو تنها سند کاربر مطابق با شناسه مطابق را
بازیابی کرده و فیلد `address` را پر می‌کند.

به یاد داشته باشید که در این مثال‌ها نام‌های مجموعه و فیلد را با طرح اصلی خود جایگزین کنید. با استفاده از `$lookup` و
درک روابط مرجع، می‌توانید به طور کارآمد داده‌های مرتبط را در مجموعه‌های مونگو دی‌بی بازیابی و مدیریت کنید.
